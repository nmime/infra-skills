# Гайд по торговому агенту V3

Полное руководство по автономной торговле на Hyperliquid с отслеживанием состояния.

---

## Что нового в V3

V3 использует KV Storage для сохранения состояния между сессиями:

| Функция | V2 | V3 |
|---------|----|----|
| Динамические стопы | ✓ | ✓ |
| Частичные тейки | ✗ | ✓ |
| Отслеживание просадки | ✗ | ✓ |
| Статистика сделок | ✗ | ✓ |
| Cooldown после убытков | ✗ | ✓ |
| Дневные лимиты | ✗ | ✓ |

---

## Режимы торговли

| Режим | Плечо | Цель | Риск | Интервал |
|-------|-------|------|------|----------|
| **Degen** | 15-25x | +100-300% | Высокий | 10 мин |
| **Aggressive** | 5-15x | +50-100% | Средний-высокий | 20 мин |
| **Balanced** | 3-5x | +25-50% | Средний | 2 часа |
| **Conservative** | 1-2x | +20%/год | Низкий | 3 дня |

---

## Как работает агент

```
┌─────────────────────────────────────────────────────────┐
│                    ЦИКЛ АГЕНТА V3                       │
├─────────────────────────────────────────────────────────┤
│                                                         │
│   1. ПРОВЕРКА СОСТОЯНИЯ (KV Storage)                   │
│      ├─► Загрузить сессию и статистику                 │
│      ├─► Проверить drawdown circuit breaker            │
│      ├─► Проверить дневной лимит убытков               │
│      └─► Проверить streak убытков                      │
│                                                         │
│   2. СКАНИРОВАНИЕ                                       │
│      └─► Агент ищет возможности по расписанию          │
│                                                         │
│   3. ПРОВЕРКИ БЕЗОПАСНОСТИ                              │
│      ├─► Ликвидность достаточная?                      │
│      ├─► Спред не слишком широкий?                     │
│      ├─► BTC в ту же сторону?                          │
│      └─► Не выходные/ночь?                             │
│                                                         │
│   4. ВХОД В СДЕЛКУ                                      │
│      ├─► Устанавливает плечо                           │
│      ├─► Рассчитывает размер (с учётом drawdown)       │
│      ├─► Ставит лимитный ордер (защита от проскальз.)  │
│      └─► Ставит Stop Loss и Take Profit                │
│                                                         │
│   5. УПРАВЛЕНИЕ ПОЗИЦИЕЙ                                │
│      ├─► Передвигает стоп в безубыток при +5%          │
│      ├─► Фиксирует 30% на 50% пути к TP                │
│      ├─► Фиксирует ещё 30% на 75% пути                 │
│      └─► Включает трейлинг при достижении TP           │
│                                                         │
│   6. ВЫХОД И ЗАПИСЬ                                     │
│      ├─► Записать сделку в историю (KV)                │
│      ├─► Обновить статистику W/L                       │
│      ├─► Обновить streak                               │
│      └─► Проверить цель сессии                         │
│                                                         │
│   7. ПОВТОР                                             │
│      └─► Если позиция закрылась → ищем новую           │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

---

## Защитные механизмы

### 1. Динамический стоп-лосс

**Автоматически передвигает стоп вверх при росте позиции:**

```
ПРИМЕР DEGEN MODE:

Вход: $100
Начальный стоп: $90 (-10%)

Цена идёт вверх:
  $100 → $105 (+5%)   │ Стоп: $90 → $99.70 (безубыток)
  $105 → $110 (+10%)  │ Стоп: $99.70 → $105 (+5% лок)
  $110 → $115 (+15%)  │ Стоп: $105 → $110 (+10% лок)
  $115 → $120 (+20%)  │ Стоп: $110 → $114 (трейлинг 5%)

Цена разворачивается:
  $120 → $114         │ Стоп срабатывает!

Результат: +14% вместо возможного -10%
```

### 2. Частичные тейки (Partial Takes)

**Фиксирует прибыль частями, чтобы не упустить движение:**

```
ПРИМЕР:

Вход: $100
Тейк: $125 (+25%)

Цена идёт вверх:
  $100 → $112.50 (50% пути к тейку)
    └─► Закрываем 30% позиции, фиксируем +12.5%

  $112.50 → $118.75 (75% пути к тейку)
    └─► Закрываем ещё 30%, фиксируем +18.75%

  Остаток (40%) едет до полного тейка или трейлинга

Результат: Даже если цена развернётся, часть прибыли уже забрана
```

### 3. Drawdown Circuit Breaker

**Автоматическая защита от больших потерь:**

| Просадка от пика | Действие |
|------------------|----------|
| -10% | ⚠️ Предупреждение, размер -30% |
| -15% | 🔶 Пауза 2 часа, размер -50% |
| -20% | 🛑 **ПОЛНАЯ ОСТАНОВКА** |

```
ПРИМЕР:

Начальный баланс: $1000
Пиковый баланс: $1200

Просадка:
  $1200 → $1080 (-10% от пика) → Предупреждение
  $1080 → $1020 (-15% от пика) → Пауза, уменьшаем размеры
  $1020 → $960 (-20% от пика)  → СТОП! Закрываем всё.

Ты сохранил $960 вместо возможных $0
```

### 4. Cooldown после убытков

| Ситуация | Действие |
|----------|----------|
| 3 убытка подряд | Пауза 4-6 часов, размер -50% |
| 5 убытков за день | Стоп на 24 часа |

**Почему:** После серии убытков рынок изменился или стратегия не работает.

### 5. Дневной лимит убытков

| Режим | Лимит | Действие |
|-------|-------|----------|
| Degen | -15% | Stop for day |
| Aggressive | -10% | Stop for day |
| Balanced | -8% | Stop for day |
| Conservative | -5% | Stop for day |

### 6. Отслеживание статистики

Агент ведёт полную статистику:

```
📊 Performance Update (15 trades)
Win rate: 67%
Total P&L: +42.3%
Avg trade: +2.8%
Best: +18.5% | Worst: -8.2%
Streak: +3 wins
```

При низком win rate (<35%) — предупреждение о пересмотре стратегии.

---

## Пример сессии Degen V3

```
═══════════════════════════════════════════════════════════
  DEGEN MODE V3 SESSION
═══════════════════════════════════════════════════════════

[10:00] 🎰 Degen mode started
        Balance: $100
        Target: $275 (+175%)
        State: Initialized in KV

[10:02] ✅ Drawdown check: OK (peak: $100)
        ✅ Daily loss: 0% (limit: 15%)
        ✅ Streak: 0 (no cooldown)

[10:03] 🟢 LONG PEPE @ $0.00001234
        Leverage: 20x | Size: $25

[10:15] 🔒 PEPE +5.2%
        Stop moved to breakeven

[10:30] 🔒 PEPE +11.3%
        Stop moved to +5%

[10:45] 💰 PEPE Partial #1
        Closed 30% at +12.5%
        Remaining: 70%

[11:00] 💰 PEPE Partial #2
        Closed 30% at +19.2%
        Remaining: 40%

[11:22] ✅ PEPE Trade completed
        P&L: +$16.25 (+16.25%)
        📝 Recorded to KV

[11:22] 📊 Stats updated
        Trades: 1 | Wins: 1 | Streak: +1
        Balance: $116.25

... продолжение ...

[15:47] 🎉 TARGET REACHED!
        $100 → $283.50 (+183.5%)
        Trades: 7 (5W/2L)
        Win rate: 71%

═══════════════════════════════════════════════════════════
```

---

## KV Storage ключи

Агент хранит состояние в этих ключах:

| Ключ | Что хранит |
|------|------------|
| `{chat_id}_session` | Сессия (баланс, цель, режим) |
| `{chat_id}_peak_balance` | Максимальный баланс (для drawdown) |
| `{chat_id}_trade_history` | История всех сделок |
| `{chat_id}_stats` | Статистика W/L, streak |
| `{chat_id}_partials_{coin}` | Какие partial takes уже взяты |
| `{chat_id}_daily_losses` | Убытки за сегодня |
| `{chat_id}_daily_date` | Дата для сброса дневного счётчика |

---

## Уведомления в Telegram

| Событие | Сообщение |
|---------|-----------|
| Старт | 🎰 Degen mode: $100 → Target: $275 |
| Drawdown | ⚠️ Drawdown -12%, size reduced 30% |
| Вход | 🟢 LONG PEPE @ $0.00001234, 20x |
| Стоп лок | 🔒 PEPE +10%, stop at +5% |
| Partial | 💰 PEPE Partial #1: 30% at +12% |
| Win | ✅ PEPE +$16 (+16%) \| 3W/1L |
| Loss | ❌ PEPE -$8 (-8%) \| Streak: -2 |
| Stats | 📊 15 trades \| 67% WR \| +42% total |
| Cooldown | ⏸️ 3 losses, pausing 4-6h |
| Halt | 🛑 HALTED: -20% drawdown |
| Target | 🎉 TARGET! $100 → $283 (+183%) \| 5W/2L |

---

## FAQ

**Q: Чем V3 лучше V2?**
A: V3 сохраняет состояние между сессиями — drawdown, статистику, partial takes. V2 "забывает" всё при каждом пробуждении.

**Q: Что если KV storage недоступен?**
A: Агент продолжит работать, но без state features. Лучше использовать V2 если KV не подключён.

**Q: Могу ли я сбросить статистику?**
A: Да, удалив ключи через splox_kv_delete или начав новую сессию.

**Q: Где хранятся данные?**
A: В KV Storage платформы Splox. Данные привязаны к chat_id.

---

## Глоссарий

| Термин | Значение |
|--------|----------|
| **KV Storage** | Key-Value хранилище для состояния |
| **Peak Balance** | Максимальный баланс за сессию |
| **Drawdown** | Просадка от пика |
| **Partial Take** | Частичная фиксация прибыли |
| **Streak** | Серия побед (+) или поражений (-) |
| **Cooldown** | Пауза после серии убытков |
| **Circuit Breaker** | Аварийная остановка при большом drawdown |

---

*Последнее обновление: Январь 2026*
